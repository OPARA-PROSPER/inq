#!/usr/bin/env ruby

require "how_is"
require "how_is/cli"
require "pathname"

begin
  parser  = HowIs::CLI::Parser.new
  result  = parser.call(ARGV)
rescue HowIs::CLI::OptionsError => e
  if ENV['SHOW_TRACE']
    raise
  else
    abort "Error: #{e.message}"
  end
end

opts      = result[:opts]
options   = result[:options]
arguments = result[:arguments]

if options[:help]
  puts result[:opts]
  exit
elsif options[:version]
  puts HowIs::VERSION
  exit
end

def save_files(reports)
  reports.each do |file, report|
    report_format = Pathname(file).extname.delete('.')
    File.open(file, 'w') do |f|
      f.write report.public_send("to_#{report_format}")
    end
  end
end

begin
  if options[:config]
    reports = HowIs.from_config(YAML.load_file(options[:config]))

    save_files(reports)
  else
    report =
      if options[:from]
        json_report = File.open(options[:from]).read
        HowIs.from_json(json_report)
      else
        HowIs.new(options[:repository])
      end

    save_files({ options[:report] => report })
  end

rescue => e
  if ENV['SHOW_TRACE']
    raise
  else
    abort "Error: #{e.message}"
  end
end

