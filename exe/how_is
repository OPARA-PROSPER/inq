#!/usr/bin/env ruby

# frozen_string_literal: true

require "how_is"
require "how_is/cli"
require "date"

begin
  opts, options = HowIs::CLI.parse(ARGV)
rescue OptionParser::ParseError => e
  abort "how_is: error: #{e.message}"
end

if options[:help]
  puts opts
  exit
elsif options[:version]
  puts HowIs::VERSION
  exit
end

date = options[:date]

begin
  if options[:config]
    reports = HowIs.from_config(YAML.load_file(options[:config]), date)

    reports.each { |file, report| report.save_as(file) }
  else
    report = HowIs.new(options[:repository], date)

    report.save_as(options[:report])
  end
rescue => e
  raise if options[:verbose]

  warn "how_is: error: #{e.message} (Pass --verbose for more details.)"
  warn "  at: #{e.backtrace_locations.first}"
  exit 1
end
